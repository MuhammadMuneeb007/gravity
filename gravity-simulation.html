<!DOCTYPE html>
<html lang="en">

<head>
    <style >
        .gradient-custom {
            background: #f093fb;

/* Chrome 10-25, Safari 5.1-6 */
background: -webkit-linear-gradient(to bottom, rgba(240, 147, 251, 0.5), rgba(245, 87, 108, 0.5))!important;

/* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
background: linear-gradient(to bottom, rgba(240, 147, 251, 0.5), rgba(245, 87, 108, 0.5))!important

}
        </style>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Free fall Gravity Simulation!</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>

<body class="p-4 gradient-custom">
    <h1 class="text-center m-4">Free fall Gravity Simulation</h1>
    <div class="d-flex flex-row justify-content-between p-4">
        <form class="col-4" id="gravity-simulation">
            <div class="mb-3">
                <label class="form-label form-control-sm" for="inputHeight">Height</label>
                <input type="number" class="form-control form-control-sm" min="0" max="220" name="inputHeight" placeholder="Height (1-220)">
            </div>
            <div class="mb-3">
                <label class="form-label form-control-sm" for="inputVelocity">Initial Velocity</label>
                <input type="number" class="form-control form-control-sm" name="inputVelocity" placeholder="Velocity (1-220)">
            </div>
            <div class="mb-3">
                <label class="form-label form-control-sm" for="inputGravity">Value of Gravity</label>
                <input type="number" class="form-control form-control-sm" min="0" name="inputGravity"
                    placeholder="Gravity (1 - 100)">
            </div>
            <div class="mb-3">
                <label class="form-label form-control-sm" for="inputSimulationSpeed">Simulation speed</label>
                <input type="number" class="form-control form-control-sm" min="0" name="inputSimulationSpeed"
                    placeholder="Simulation Speed (0 - 1)">
            </div>
            <div class="mb-3">
                <label class="form-label form-control-sm" for="inputCoefficientOfRestitution">Coefficient of
                    Restitution</label>
                <input type="number" class="form-control form-control-sm" name="inputCoefficientOfRestitution"
                    placeholder="Coefficient of Restitution (0 - 1)">
            </div>
            <div class="d-flex flex-row justify-content-between align-item-center">
                <button type="button" id="startSimulation" class="w-100 btn btn-dark" style="margin-right: 4px; margin-bottom: 0;">Start
                    Simulation</button>
                <button type="button" id="stopSimulation" class="btn btn-danger" style="margin-bottom: 0px;">Stop</button>
            </div>

        </form>
        <canvas id="simCanvas" width="300"  height="220" position="fixed"
            class="rounded border border-2 bg-white border-secondary col-6"></canvas>
    </div>


    <script>
        let context = simCanvas.getContext('2d');
        
        const WIDTH = 300;
        const HEIGHT = 220;
        let x = 150;
        let y = 0;
        let vx = 1;
        let vy = 1;
        let h0 = 220;
        let dx = 5;
        let dy = 5;
        let t = 0;
        
        
        let v = 0;
        let g = 1.9;
        let dt = 0.1;
        let rho = 0.75;
        let tau = 0.010;
        let hmax = h0;
        let h = h0;
        let hstop = 10;
        let freefall = 1;
        let t_last = -Math.sqrt(2 * h0 / g);
        let vmax = Math.sqrt(2 * hmax * g);

        let ballx = WIDTH / 2;
        let bally = h0;
        
        let simIntervalId = null;

        function draw() {

            if (hmax > hstop) {
                context.clearRect(0, 0, WIDTH, HEIGHT);
                context.beginPath();
                context.fillStyle = "#0dcaf0";

                if (freefall) {
                    hnew = h + v * dt - 0.5 * g * dt * dt
                    if (hnew < 0) {
                        t = t_last + 2 * Math.sqrt(2 * hmax / g)
                        freefall = 0
                        t_last = t + tau
                        h = 0
                    }
                    else {
                        t = t + dt
                        v = v - g * dt
                        h = hnew
                    }
                }
                else {
                    t = t + tau
                    vmax = vmax * rho
                    v = vmax
                    freefall = 1
                    h = 0
                }

                hmax = 0.5 * vmax * vmax / g

                ballx = WIDTH / 2
                bally = HEIGHT - h - 5 // subtract 5 to make sure ball will be visible on the bottom surface
                context.arc(ballx, parseInt(bally), 5, 0, 2 * Math.PI);
                context.closePath();
                context.fill();
            }
        }

        document.getElementById("startSimulation").addEventListener("click", function () {

            if(simIntervalId) {
                return console.log("Simulation is already running");
            }

            const simulationForm = document.getElementById("gravity-simulation");
            const formData = new FormData(simulationForm);
            let formProps = Object.fromEntries(formData);

            // convert string values to integer
            formProps = Object.entries(formProps)
                .reduce((agg, [currentProps, val]) => {
                    return {
                        ...agg,
                        [currentProps]: parseNumber(val)
                    }
                }, {});


            console.log(formProps)
            if(formProps.inputHeight<=0 || formProps.inputHeight>220){
                return alert("Height must be between 0 - 220");       
            }
            if(formProps.inputVelocity<0 || formProps.inputVelocity>10){
                return alert("Input Velocity must be between 0 - 10");       
            }
            if(formProps.inputGravity<=0 || formProps.inputGravity>100){
                return alert("Value of Gravity must be between 1 - 100");       
            }
            if(formProps.inputSimulationSpeed<0 || formProps.inputSimulationSpeed>1){
                return alert("Simulation speed must be between 0 - 1");       
            }
            if(formProps.inputCoefficientOfRestitution<0 || formProps.inputCoefficientOfRestitution>1){
                return alert("Coefficient of Restitution must be between 0 - 1");       
            }
            
            //const hasAnyPropValLessThanOne = Object.entries(formProps).filter(([key, val]) => val <= 0);

            // if(hasAnyPropValLessThanOne.length > 0) {
            //     return alert("All parameters must be greater than 0!");
            // }

            h0 = formProps.inputHeight;
            v = formProps.inputVelocity;
            g = formProps.inputGravity;
            dt = formProps.inputSimulationSpeed;
            rho = formProps.inputCoefficientOfRestitution;

            hmax = h0;
            h = h0;
            t_last = -Math.sqrt(2 * h0 / g);
            vmax = Math.sqrt(2 * hmax * g);
            ballx = WIDTH / 2;
            bally = h0;
            vx = 1;
            vy = 1;

            simIntervalId = setInterval(draw, 1);
        });

        document.getElementById("stopSimulation").addEventListener("click", function () {
            // stop simulation
            clearInterval(simIntervalId);
            simIntervalId = null;
            // clear canvas
            context.clearRect(0, 0, WIDTH, HEIGHT);
            // clear form input fields
            document.getElementById("gravity-simulation").reset();
        });

        function parseNumber(number) {
            const parsedNumber = parseFloat(number)
            if (isNaN(parsedNumber)) {
                return 0
            }
            return parsedNumber
        }

    </script>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous">
        </script>

</body>

</html>